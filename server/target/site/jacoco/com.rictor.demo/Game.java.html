<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">com.rictor.demo</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package com.rictor.demo;

import org.java_websocket.WebSocket;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Random;

// import java.util.Timer;
// import java.util.TimerTask;

public class Game {
    public short numPlayers;
    public short round;
<span class="pc" id="L18">    public short NUM_ROUNDS = 3;</span>
<span class="pc" id="L19">    public int phase = -1;</span>
<span class="pc" id="L20">    public int time = 60;</span>
    public int indexOfIt;
<span class="pc" id="L22">    public boolean itWins = true;</span>
    public int[] scores;
    public int[] votes;
    public ArrayList&lt;Player&gt; players;
    public ArrayList&lt;String&gt; playerNames;

    public boolean[] bonus;
    public boolean[] submitted;
    public String[][] allQuotes;
    public boolean[] usedQuotes;
    public String[][] quoteChoices;
    public String[] quote;
    public String[][] submittedQuotes;
    
    public boolean end;
    public boolean results;




//game phases: pre-game = -1, choosing quote = 0, writing = 1, voting = 2

    WebsocketServer wss;

<span class="fc" id="L46">    Game(){ //test constructor</span>
<span class="fc" id="L47">        this.numPlayers=0;</span>
<span class="fc" id="L48">        this.players = new ArrayList&lt;Player&gt;();</span>
<span class="fc" id="L49">        this.playerNames = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L50">    }</span>
<span class="nc" id="L51">    Game(WebsocketServer wss) {</span>
<span class="nc" id="L52">        readFile(&quot;sourceQuotes&quot;);</span>
<span class="nc" id="L53">        this.numPlayers=0;</span>
<span class="nc" id="L54">        this.players = new ArrayList&lt;Player&gt;();</span>
<span class="nc" id="L55">        this.playerNames = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L56">        this.wss = wss;</span>
<span class="nc" id="L57">        System.out.println(&quot;New Game on &quot; + wss.getPort() + &quot;!&quot;);</span>
<span class="nc" id="L58">    }</span>
    public void broadcast(){
<span class="nc" id="L60">        wss.broadcast();</span>
<span class="nc" id="L61">    }</span>
    public void readFile(String filename) {        
        try {
<span class="fc" id="L64">            BufferedReader bufferedReader = new BufferedReader(</span>
<span class="fc" id="L65">                    new InputStreamReader(getClass().getClassLoader().getResourceAsStream(filename),</span>
<span class="fc" id="L66">                            Charset.defaultCharset()));</span>
<span class="fc" id="L67">            int numQuotes = Integer.parseInt(bufferedReader.readLine());</span>
<span class="fc" id="L68">            allQuotes = new String[numQuotes][4];</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            for (int i = 0; i &lt; numQuotes; i++) {</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">                for(int j = 0; j&lt;3; j++) {</span>
<span class="fc" id="L71">                    allQuotes[i][j] = bufferedReader.readLine();</span>
                }
<span class="fc" id="L73">                allQuotes[i][3]=&quot;-1&quot;;</span>
            }
<span class="fc" id="L75">            usedQuotes = new boolean[allQuotes.length];</span>
<span class="nc" id="L76">        } catch (Exception e) {</span>
<span class="nc" id="L77">            System.out.println(e.getStackTrace());</span>
<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">        System.out.println(&quot;Read in quotes:&quot;);</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        for(String[] q : allQuotes) {</span>
<span class="fc" id="L81">            System.out.println(Arrays.toString(q));</span>
        }
<span class="fc" id="L83">    }</span>
    
    public boolean allSubmitted(){
<span class="nc bnc" id="L86" title="All 2 branches missed.">        for(int i = 0; i&lt;this.submitted.length; i++) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if(i==this.indexOfIt) continue;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if(!this.submitted[i]) return false;</span>
        }
<span class="nc" id="L90">        return true;</span>
    }
    public void addPlayer(String name, WebSocket conn){
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if(this.playerNames.contains(name) &amp;&amp; this.players.get(this.playerNames.indexOf(name)).address.equals(conn.getRemoteSocketAddress().getAddress().getHostAddress())) {</span>
<span class="nc" id="L94">            System.out.println(&quot;Welcome back...&quot;);</span>
<span class="nc" id="L95">            this.players.get(this.playerNames.indexOf(name)).connection = conn;</span>
<span class="nc" id="L96">            return;</span>
        }
<span class="nc" id="L98">		Player player = new Player(numPlayers, name, conn);</span>
<span class="nc" id="L99">		this.numPlayers++;</span>
<span class="nc" id="L100">        players.add(player);</span>
<span class="nc" id="L101">        playerNames.add(name);</span>
<span class="nc" id="L102">        System.out.println(&quot;Added &quot; + name + &quot; to game!&quot;);</span>
<span class="nc" id="L103">        System.out.println(numPlayers + &quot; current players:\n&quot; + playerNames);</span>
<span class="nc" id="L104">    }</span>
    
	public void removePlayer(int index){
<span class="nc" id="L107">        players.remove(index);</span>
<span class="nc" id="L108">        playerNames.remove(index);</span>
<span class="nc" id="L109">        this.numPlayers--;</span>
<span class="nc" id="L110">    }</span>
    
    public void startGame(short rounds) {

<span class="nc" id="L114">        this.scores = new int[numPlayers];</span>
<span class="nc" id="L115">        this.submitted = new boolean[numPlayers];</span>
<span class="nc" id="L116">        this.indexOfIt = 0;</span>
<span class="nc" id="L117">        this.round = 1;</span>
<span class="nc" id="L118">        choice();</span>
<span class="nc" id="L119">    }</span>

    public void choice(){
<span class="nc" id="L122">        wss.timer();</span>
<span class="nc" id="L123">        this.phase = 0;</span>
<span class="nc" id="L124">        Random r = new Random();</span>
<span class="nc" id="L125">        quoteChoices = new String[3][4];</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        for(int i = 0; i&lt;quoteChoices.length; i++) {</span>
<span class="nc" id="L127">            int index = r.nextInt(allQuotes.length);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            while(usedQuotes[index]) {</span>
<span class="nc" id="L129">                System.out.println(&quot;Can't use \&quot;&quot; + allQuotes[index][1]+&quot; &quot;+ allQuotes[index][2] + &quot;\&quot;&quot;);</span>
<span class="nc" id="L130">                index = r.nextInt(allQuotes.length);</span>
            }
<span class="nc" id="L132">            quoteChoices[i] = allQuotes[index];</span>
<span class="nc" id="L133">            usedQuotes[index] = true;</span>
        }
<span class="nc" id="L135">        submittedQuotes = new String[this.numPlayers][4];</span>
<span class="nc" id="L136">        bonus = new boolean[this.numPlayers];</span>
<span class="nc" id="L137">    }</span>
    public void setQuote(String[] quote, int index){
<span class="nc" id="L139">        quote[3] = &quot;&quot; + index;</span>
<span class="nc" id="L140">        System.out.println(&quot;Setting quote for player &quot; + index + &quot; to \&quot;&quot; + quote[1] + &quot; &quot; + quote[2] + &quot;\&quot;&quot;);</span>
<span class="nc" id="L141">        this.submittedQuotes[index] = quote;</span>
<span class="nc" id="L142">        this.submitted[index] = true;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if(this.phase==0) {</span>
<span class="nc" id="L144">            this.quote = quote;</span>
<span class="nc" id="L145">            this.phase = 1;</span>
<span class="nc" id="L146">            wss.timer();</span>
        }
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (this.allSubmitted()) {</span>
<span class="nc" id="L149">            shuffleArray(this.submittedQuotes);</span>
<span class="nc" id="L150">            this.submitted = new boolean[this.numPlayers];</span>
<span class="nc" id="L151">            this.phase = 2;</span>
<span class="nc" id="L152">            wss.timer();</span>
        }
<span class="nc" id="L154">        votes = new int[players.size()];</span>
<span class="nc" id="L155">        wss.broadcast();</span>
<span class="nc" id="L156">    }</span>
    public void awardBonus(int index) {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        this.bonus[index]=!this.bonus[index];</span>
<span class="nc" id="L159">    }</span>
    public void showResults() {
<span class="nc" id="L161">        this.results = true;</span>
<span class="nc" id="L162">        broadcast();</span>
<span class="nc" id="L163">    }</span>

    public void vote(int voteIndex, int index) {
<span class="nc" id="L166">        submitted[index]=true;</span>
        
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if(voteIndex==indexOfIt) {</span>
<span class="nc" id="L169">            scores[index]+=2;</span>
<span class="nc" id="L170">            itWins = false;</span>
        }
<span class="nc bnc" id="L172" title="All 2 branches missed.">        else if(voteIndex==-1); //player failed to vote in time; </span>
<span class="nc" id="L173">        else scores[voteIndex]+=2;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if(voteIndex!=-1) votes[voteIndex]++;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if(this.allSubmitted()){</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if(itWins) scores[indexOfIt]+=3;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            for(int i = 0; i&lt;numPlayers; i++) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if(this.bonus[i]) this.scores[i]++;</span>
            }
<span class="nc" id="L180">            showResults();</span>
        }
<span class="nc" id="L182">    }</span>
    public void nextRound(){
<span class="nc" id="L184">        this.results = false;</span>
<span class="nc" id="L185">        this.submitted = new boolean[this.numPlayers];</span>
<span class="nc" id="L186">        this.itWins = true;</span>
<span class="nc" id="L187">        this.indexOfIt++;</span>
<span class="nc" id="L188">        this.indexOfIt = this.indexOfIt % this.numPlayers;</span>
        
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if(this.indexOfIt==0) this.round++;</span>
        
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if(this.round&gt;this.NUM_ROUNDS) endGame();</span>
<span class="nc" id="L193">        else choice();</span>
<span class="nc" id="L194">    }</span>

    public void endGame(){
<span class="nc" id="L197">        this.end = true;      </span>
<span class="nc" id="L198">        this.phase = 3;</span>
<span class="nc" id="L199">        this.round = 0;</span>
<span class="nc" id="L200">    }  </span>

    public void reset(){
<span class="nc bnc" id="L203" title="All 2 branches missed.">        for(int i = 0; i&lt;this.numPlayers; i++){</span>
<span class="nc" id="L204">            this.players.remove(0);</span>
<span class="nc" id="L205">            this.playerNames.remove(0);</span>
        }
<span class="nc" id="L207">        this.end = false;</span>
<span class="nc" id="L208">        this.numPlayers = 0;</span>
<span class="nc" id="L209">        this.scores = null;</span>
<span class="nc" id="L210">        this.itWins = true;</span>
<span class="nc" id="L211">        this.usedQuotes = new boolean[allQuotes.length];</span>
<span class="nc" id="L212">        this.submitted = null;</span>
<span class="nc" id="L213">        this.bonus = null;</span>
<span class="nc" id="L214">        this.phase = -1;</span>
<span class="nc" id="L215">        wss.broadcast(true);</span>
<span class="nc" id="L216">    }</span>
    private static void shuffleArray(String[][] array){
        int index;
        String[] temp;
<span class="nc" id="L220">        Random random = new Random();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        for (int i = array.length - 1; i &gt; 0; i--)</span>
        {
<span class="nc" id="L223">            index = random.nextInt(i + 1);</span>
<span class="nc" id="L224">            temp = array[index];</span>
<span class="nc" id="L225">            array[index] = array[i];</span>
<span class="nc" id="L226">            array[i] = temp;</span>
        }
<span class="nc" id="L228">    } </span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>